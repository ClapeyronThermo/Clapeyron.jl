abstract type SAFTVRMie15Model <: SAFTVRMieModel end
@newmodel SAFTVRMie15 SAFTVRMie15Model SAFTVRMieParam{T}
default_references(::Type{SAFTVRMie15}) = ["10.1063/1.4819786", "10.1080/00268976.2015.1029027"]
default_locations(::Type{SAFTVRMie15}) = ["SAFT/SAFTVRMie/MieKernel", "properties/molarmass.csv"]
function transform_params(::Type{SAFTVRMie15},params)
    sigma = params["sigma"]
    sigma.values .*= 1E-10
    sigma = sigma_LorentzBerthelot(sigma)
    epsilon = epsilon_HudsenMcCoubrey(params["epsilon"], sigma)
    lambda_a = lambda_LorentzBerthelot(params["lambda_a"])
    lambda_r = lambda_LorentzBerthelot(params["lambda_r"])
    params["sigma"] = sigma
    params["epsilon"] = epsilon
    params["lambda_a"] = lambda_a
    params["lambda_r"] = lambda_r
    return params
end
"""
    SAFTVRMie15Model <: SAFTVRMieModel

    SAFTVRMie(components;
    idealmodel = BasicIdeal,
    userlocations = String[],
    ideal_userlocations = String[],
    reference_state = nothing,
    verbose = false,
    assoc_options = AssocOptions())

## Input parameters
- `Mw`: Single Parameter (`Float64`) - Molecular Weight `[g/mol]`
- `segment`: Single Parameter (`Float64`) - Number of segments (no units)
- `sigma`: Single Parameter (`Float64`) - Segment Diameter [`A°`]
- `epsilon`: Single Parameter (`Float64`) - Reduced dispersion energy  `[K]`
- `lambda_a`: Pair Parameter (`Float64`) - Atractive range parameter (no units)
- `lambda_r`: Pair Parameter (`Float64`) - Repulsive range parameter (no units)
- `k`: Pair Parameter (`Float64`) (optional) - Binary Interaction Paramater (no units)
- `epsilon_assoc`: Association Parameter (`Float64`) - Reduced association energy `[K]`
- `bondvol`: Association Parameter (`Float64`) - Association Volume

## Model Parameters
- `Mw`: Single Parameter (`Float64`) - Molecular Weight `[g/mol]`
- `segment`: Single Parameter (`Float64`) - Number of segments (no units)
- `sigma`: Pair Parameter (`Float64`) - Mixed segment Diameter `[m]`
- `lambda_a`: Pair Parameter (`Float64`) - Atractive range parameter (no units)
- `lambda_r`: Pair Parameter (`Float64`) - Repulsive range parameter (no units)
- `epsilon`: Pair Parameter (`Float64`) - Mixed reduced dispersion energy`[K]`
- `epsilon_assoc`: Association Parameter (`Float64`) - Reduced association energy `[K]`
- `bondvol`: Association Parameter (`Float64`) - Association Volume

## Input models
- `idealmodel`: Ideal Model

## Description

SAFT-VR with Mie potential and the Mie association kernel

## References
1. Lafitte, T., Apostolakou, A., Avendaño, C., Galindo, A., Adjiman, C. S., Müller, E. A., & Jackson, G. (2013). Accurate statistical associating fluid theory for chain molecules formed from Mie segments. The Journal of Chemical Physics, 139(15), 154504. [doi:10.1063/1.4819786](https://doi.org/10.1063/1.4819786)
2. Dufal, S., Lafitte, T., Haslam, A. J., Galindo, A., Clark, G. N. I., Vega, C., & Jackson, G. (2015). The A in SAFT: developing the contribution of association to the Helmholtz free energy within a Wertheim TPT1 treatment of generic Mie fluids. Molecular Physics, 113(9–10), 948–984. [doi:10.1080/00268976.2015.1029027](https://doi.org/10.1080/00268976.2015.1029027)
"""
SAFTVRMie15

export SAFTVRMie15

function x0_volume_liquid(model::SAFTVRMie15Model,T,z)
    v_lb = lb_volume(model,z)
    return v_lb*1.7
end
#=
function I(model::SAFTVRMie15Model, V, T, z,i, j,_data = @f(data))
    _d,ρS,ζi,_ζ_X,_ζst,σ3_x = _data
    ϵ = model.params.epsilon.values[i,j]
    Tr = T/ϵ
    λr = model.params.lambda_r.values[i,j]
    res = zero(_ζst)
    ρr = ρS*σ3_x
    b = SAFTVRMie15consts.b
    @inbounds for n ∈ 0:10
        ρrn = ρr^n
        res_m = zero(res)
        for m ∈ 0:(10-n)
            Trm = Tr^m
            λrk = one(res_m)
            a_mie = zero(res_m)
            for k in 0:6
                a_mie += b[k+1][n+1,m+1]*λrk
                λrk *= λr
            end
            res_m += a_mie*Tr^m
        end
        res += res_m*ρrn
    end
    return res
end
=#
#from teqp
function I(model::SAFTVRMie15Model, V, T, z,i, j,_data = @f(data))
    _d,ρS,ζi,_ζ_X,_ζst,σ3_x = _data
    ϵ = model.params.epsilon.values[i,j]
    Tr = T/ϵ
    λr = model.params.lambda_r.values[i,j]
    res = zero(_ζst)
    ρr = ρS*σ3_x
    b = SAFTVRMie15consts.b
    rhostar_to_i = one(res)
    @inbounds for i = 0:10
        Tstar_to_j = one(res)
        for j = 0:(10-i)                                                     
            aij = zero(res)
            lambdar_to_k = one(res)
            for k = 0:6
                bijk = b[k+1][i+1,j+1]
                aij = aij + bijk*lambdar_to_k
                lambdar_to_k = lambdar_to_k * λr
            end
            res = res + aij*rhostar_to_i*Tstar_to_j
            Tstar_to_j = Tstar_to_j * Tr
        end
        rhostar_to_i = rhostar_to_i * ρr
    end
    return res
end

const SAFTVRMie15consts = (
   b = [[0.0132970702182068	-0.0177199122935443	0.0293736747694974	-0.0205527304404423	0.00861683420907605	-0.00228505275303600	0.000390171133200072	-4.26035888869942e-05	2.86246920519487e-06	-1.07315320963937e-07	1.70912976772329e-09
        -0.0465504528847432	0.332597325549352	-0.326575316241193	0.144653671541451	-0.0363193315289496	0.00569934220115537	-0.000581966173216051	3.83608167089024e-05	-1.50305409953983e-06	2.66749257811143e-08	0
        0.164972499633366	-0.974898725377830	0.919082550772666	-0.367978443660284	0.0788054156983951	-0.00981102799831725	0.000717901835772044	-2.91191052989125e-05	5.17207032026779e-07	0	0
        -0.553080054304108	1.07124021914524	-0.914915281734471	0.328132391309741	-0.0577909160509185	0.00539941935098940	-0.000249522541631115	4.36324500072586e-06	0	0	0
        0.697481173735912	-0.127802319197572	0.238559496985344	-0.124364954974360	0.0183583032370354	-0.00133946361388127	3.68888649118614e-05	0	0	0	0
        -0.00682258598593205	-0.296768597044265	0.346077751701231	0.0122496582163678	-0.000805951611068984	5.01775524378700e-05	0	0	0	0	0
        -2.46482416179796	-1.45370322973416	-0.448827080921154	-0.00566229179136722	-0.000180870029200998	0	0	0	0	0	0
        8.78388694047369	3.23807384513205	0.281816142695178	0.00340169105539079	0	0	0	0	0	0	0
        -13.5178089781880	-2.48217551606281	-0.0783334040233511	0	0	0	0	0	0	0	0
        9.42415649943917	0.687363680163044	0	0	0	0	0	0	0	0	0
        -2.46151453173016	0	0	0	0	0	0	0	0	0	0],
        [0.000556479463564548	-0.000282932524693843	-0.00212156862728691	0.00224197388058698	-0.00115385075260200	0.000345261305021541	-6.36772702454557e-05	7.32538316171651e-06	-5.10881831259873e-07	1.97049247692837e-08	-3.21285622252695e-10
        0.0492332122696642	-0.134456183191719	0.108517185632299	-0.0425401431513956	0.00954409805564329	-0.00131479859839035	0.000113485041044446	-5.97590027689909e-06	1.73112888670222e-07	-2.01831274082934e-09	0
        -0.158447251265296	0.430576656790814	-0.342386658999542	0.126318819450003	-0.0257089028169037	0.00310740070593876	-0.000226247702797060	9.40337471999922e-06	-1.75927011626452e-07	0	0
        0.130961541597078	-0.358137806097004	0.323521260711548	-0.113820803061658	0.0192702466504444	-0.00169264438876774	7.20470394807155e-05	-1.12895786020720e-06	0	0	0
        -0.0678784049001058	-0.159716521155965	-0.0408260244006866	0.0397261699377944	-0.00668853458452261	0.000490515978818942	-1.26640904345952e-05	0	0	0	0
        0.611672146147809	0.257963755040360	-0.150206376568020	0.00387683716563604	0.000113887448052591	-2.67212361539355e-05	0	0	0	0	0
        -1.27512696874714	0.421048118713917	0.122792263121120	-0.00158386412295998	0.000198370689434891	0	0	0	0	0	0
        0.269957785723510	-0.899401835359301	-0.0593934567946635	-0.00110977335239395	0	0	0	0	0	0	0
        1.49379616940916	0.628459498670159	0.0177032259427776	0	0	0	0	0	0	0	0
        -1.50913781396606	-0.166624388301135	0	0	0	0	0	0	0	0	0
        0.444942467424175	0	0	0	0	0	0	0	0	0	0],
        [4.68753836985661e-05	-0.000201534029276569	0.000408971640196116	-0.000334428221392103	0.000154951071291061	-4.39272547633533e-05	7.86877804626315e-06	-8.92538365355001e-07	6.20541126317064e-08	-2.40904019797940e-09	3.99225753392296e-11
        -0.00636142804034125	0.0148870088793584	-0.0112930088940554	0.00423537018032177	-0.000909633136025822	0.000118406467168496	-9.31205117458790e-06	4.07198179416416e-07	-7.24002263850399e-09	-2.85054817786792e-11	0
        0.0211014984424621	-0.0495382445219106	0.0371909493534914	-0.0132662359974178	0.00264252348906371	-0.000316720398760111	2.32682269109226e-05	-9.93969228161767e-07	1.93247731973246e-08	0	0
        -0.0204522546881708	0.0456627841733661	-0.0375241588712114	0.0125888572116524	-0.00204736822270412	0.000171672501041056	-6.91918528995779e-06	1.02234151256019e-07	0	0	0
        0.0267157884350682	0.00604022182900132	0.00822450412680841	-0.00502124889994980	0.000803630265796884	-5.55280746686634e-05	1.30402695735287e-06	0	0	0	0
        -0.131004401410042	-0.00985163509226622	0.0128544254818812	-0.000216912930642026	-4.55721397631024e-05	4.78472396442476e-06	0	0	0	0	0
        0.260822991454304	-0.0626432527852684	-0.00959839254636274	0.000223341727285368	-2.78886526475732e-05	0	0	0	0	0	0
        -0.179706752593973	0.0989212484451187	0.00388197187439871	0.000151511550199890	0	0	0	0	0	0	0
        -0.0315900588187112	-0.0607681438566115	-0.00141908354521815	0	0	0	0	0	0	0	0
        0.0926908832419059	0.0151506077043458	0	0	0	0	0	0	0	0	0
        -0.0312717011022248	0	0	0	0	0	0	0	0	0	0],
        [-1.52750755540612e-06	6.65734616244750e-06	-1.49163457856162e-05	1.28251715836463e-05	-6.13363502620892e-06	1.77374828289499e-06	-3.21719278338969e-07	3.67816571475073e-08	-2.57070860278200e-09	1.00187848111417e-10	-1.66615681224878e-12
        0.000352707112753263	-0.000761494022700993	0.000551126114938543	-0.000197194099229223	3.97623327839760e-05	-4.65836276873807e-06	2.92850782905453e-07	-5.67255537711216e-09	-3.50155347187566e-10	1.64319946681537e-11	0
        -0.00127835416513710	0.00272631887421459	-0.00195876152374924	0.000680170219619246	-0.000133171449466011	1.58508191731109e-05	-1.17119945008334e-06	5.09014996522337e-08	-1.01109171728229e-09	0	0
        0.00164258140843764	-0.00294360803306568	0.00215659810736663	-0.000685370482291315	0.000107391347801278	-8.69254977310800e-06	3.38632787324714e-07	-4.90436065438310e-09	0	0	0
        -0.00296574649489361	0.000737340818584580	-0.000762065788926240	0.000315097078455367	-4.64683975120556e-05	3.00942802764189e-06	-6.47808066443911e-08	0	0	0	0
        0.0104319873447675	-0.000775429459116355	-0.000379064014723981	-1.60783833898331e-05	4.71880061366660e-06	-3.40226871507608e-07	0	0	0	0	0
        -0.0195358884282327	0.00420143444237083	0.000297766652427410	-8.36498131244475e-06	1.51044087021239e-06	0	0	0	0	0	0
        0.0164362361737192	-0.00527606737824625	-9.27089410962249e-05	-9.32930119768768e-06	0	0	0	0	0	0	0
        -0.00439666318131193	0.00287829011566385	5.24103094975034e-05	0	0	0	0	0	0	0	0
        -0.00159566365617165	-0.000667764807450442	0	0	0	0	0	0	0	0	0
        0.000861407443430205	0	0	0	0	0	0	0	0	0	0],
        [-3.67201230932920e-08	6.65433123492297e-08	8.09753253026481e-08	-1.29349636796981e-07	7.75034942364271e-08	-2.50442449553800e-08	4.81969764886444e-09	-5.68335864091982e-10	4.02544652605731e-11	-1.57057135789188e-12	2.59018065150187e-14
        -1.00533098186312e-05	2.04973785455268e-05	-1.42364525555262e-05	4.84859626533717e-06	-9.03287394521535e-07	8.95403985256519e-08	-3.05175477078061e-09	-2.51206227550094e-10	2.85888337544568e-11	-8.35713691699930e-13	0
        3.98289826660923e-05	-7.92066147384541e-05	5.49066841157859e-05	-1.86402735397850e-05	3.59640611239294e-06	-4.25136583233798e-07	3.14701885589044e-08	-1.37942010763254e-09	2.76625894833152e-11	0	0
        -6.22606152603800e-05	9.78661859355705e-05	-6.54711127544114e-05	1.98394792303955e-05	-3.01458972861098e-06	2.38076581975360e-07	-9.12137235540096e-09	1.33298781401136e-10	0	0	0
        0.000124810638661335	-5.13612052054272e-05	3.09432853737792e-05	-1.02009751236812e-05	1.39714413579629e-06	-8.55034278983589e-08	1.71150044927963e-09	0	0	0	0
        -0.000374044099050907	5.60796050391817e-05	1.84626127086989e-06	1.34288528575647e-06	-1.94614655230730e-07	1.14157863743549e-08	0	0	0	0	0
        0.000672078359176232	-0.000138031320636187	-3.14894396008512e-06	5.76785692862702e-08	-3.88710150387342e-08	0	0	0	0	0	0
        -0.000609145837554261	0.000148275594790438	2.61353677755675e-07	2.91087061127825e-07	0	0	0	0	0	0	0
        0.000252724106819134	-7.36076396864788e-05	-1.00642768627400e-06	0	0	0	0	0	0	0	0
        -2.49255867787548e-05	1.59720037817341e-05	0	0	0	0	0	0	0	0	0
        -7.70341617155424e-06	0	0	0	0	0	0	0	0	0	0],
        [1.88048156944327e-09	-5.20041750295709e-09	4.35881692094647e-09	-1.90967917025464e-09	4.36098784939288e-10	-4.66145781784596e-11	2.56821311477203e-13	4.53836639240824e-13	-4.35569028016719e-14	1.51660179879606e-15	-1.34231785680549e-17
        1.44492319539037e-07	-2.81833237588783e-07	1.88795822312826e-07	-6.12284776821388e-08	1.04054640162243e-08	-7.91894115995732e-10	-1.78097006314277e-11	8.46173387258907e-12	-6.29468789021339e-13	1.62914975397206e-14	0
        -6.16808609401052e-07	1.16624214027143e-06	-7.85736422030061e-07	2.61841021616088e-07	-4.99004695268396e-08	5.85970807128971e-09	-4.33266245043971e-10	1.90360900947593e-11	-3.82506468133384e-13	0	0
        1.08977129458469e-06	-1.59381377689636e-06	9.99496177147637e-07	-2.91595588554532e-07	4.32652379690724e-08	-3.36277868350366e-09	1.28216601435668e-10	-1.91702973428801e-12	0	0	0
        -2.25971486750789e-06	1.11917575440765e-06	-5.65159033070467e-07	1.62627589914010e-07	-2.09918759575187e-08	1.22756291392471e-09	-2.32414275161676e-11	0	0	0	0
        6.17883043382806e-06	-1.20280382926209e-06	8.66499935530469e-08	-3.13263066251902e-08	3.53265909236495e-09	-1.81505995831496e-10	0	0	0	0	0
        -1.08048264112286e-05	2.17366900821365e-06	-1.53022515538303e-08	2.11500280833261e-09	4.74260725560735e-10	0	0	0	0	0	0
        1.01466386059898e-05	-2.10287523493265e-06	1.91184417519603e-08	-4.48828024315313e-09	0	0	0	0	0	0	0
        -4.89026741776877e-06	9.75457041464072e-07	1.00074660431270e-08	0	0	0	0	0	0	0	0
        1.04333009405285e-06	-2.00783047336916e-07	0	0	0	0	0	0	0	0	0
        -5.01517451094617e-08	0	0	0	0	0	0	0	0	0	0],
        [-1.84421844661105e-11	5.39073389353030e-11	-5.61963272868663e-11	3.23187813505929e-11	-1.13265016166587e-11	2.59326201844053e-12	-4.01407631594698e-13	4.20546124661511e-14	-2.87018830339552e-15	1.15159946184350e-16	-2.05485407533207e-18
        -8.27665331374217e-10	1.55896078845997e-09	-1.01231143749898e-09	3.13409590234525e-10	-4.81050397623846e-11	2.30261130144263e-12	3.82442150265529e-13	-7.05793035532524e-14	4.59807633591802e-15	-1.12579371971295e-16	0
        3.74547734805679e-09	-6.83326218348459e-09	4.50304220343962e-09	-1.47842817249421e-09	2.78924412091172e-10	-3.25532731205188e-11	2.40008362810406e-12	-1.05309962007498e-13	2.11144278824276e-15	0	0
        -7.12756897329521e-09	1.00393010742688e-08	-6.02106444139650e-09	1.70643459526364e-09	-2.48716300671280e-10	1.91426474551801e-11	-7.31095625646731e-13	1.12112566023581e-14	0	0	0
        1.48400265810797e-08	-8.18214743502133e-09	3.81858691213582e-09	-1.00814014221601e-09	1.24324450815098e-10	-7.02051970613448e-12	1.27771307749498e-13	0	0	0	0
        -3.82128399646057e-08	8.61165773602971e-09	-1.03558713701492e-09	2.39230607884171e-10	-2.35824243963634e-11	1.10391700857033e-12	0	0	0	0	0
        6.55633333711198e-08	-1.31376750286488e-08	3.55287199097211e-10	-2.85768231341124e-11	-2.19531090111075e-12	0	0	0	0	0	0
        -6.26595167233416e-08	1.18345081383843e-08	-1.95221464285268e-10	2.70989222978676e-11	0	0	0	0	0	0	0
        3.22964489272539e-08	-5.24025196193952e-09	-4.14196554462777e-11	0	0	0	0	0	0	0	0
        -8.35760085684382e-09	1.03868339224250e-09	0	0	0	0	0	0	0	0	0
        8.47595203890549e-10	0	0	0	0	0	0	0	0	0	0]],
)
